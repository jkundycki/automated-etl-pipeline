name: nightly-etl
on:
  schedule:
    - cron: "15 04 * * *"   # runs at 04:15 UTC nightly
  workflow_dispatch:

permissions:
  id-token: write
  contents: read

env:
  AWS_REGION: us-west-2
  S3_BUCKET: automated-etl-pipeline
  ATHENA_OUTPUT: s3://automated-etl-pipeline/athena-results/
  DB: automated_etl_db
  HOURLY_TABLE: weather_hourly
  ICEBERG_TABLE: city_daily_summary_iceberg

jobs:
  run:
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@v4

      - uses: actions/setup-python@v5
        with:
          python-version: "3.11"

      - run: pip install -r requirements.txt

      - name: Configure AWS creds (OIDC)
        uses: aws-actions/configure-aws-credentials@v4
        with:
          role-to-assume: arn:aws:iam::938116566456:role/github-actions-etl
          aws-region: ${{ env.AWS_REGION }}

      # --------- 1) Run Python ETL (extract, transform, load) ----------
      - name: Run ETL
        env:
          WEATHER_BUCKET: ${{ env.S3_BUCKET }}
          WEATHER_LOCATIONS: >-
            [{"name":"seattle","lat":47.6062,"lon":-122.3321},
             {"name":"newyork","lat":40.7128,"lon":-74.0060}]
        run: python main.py

      # --------- 2) Refresh partitions for hourly ----------
      - name: MSCK hourly
        run: |
          set -euo pipefail
          Q="MSCK REPAIR TABLE ${{ env.DB }}.${{ env.HOURLY_TABLE }}"
          QID=$(aws athena start-query-execution \
                  --work-group primary \
                  --query-string "$Q" \
                  --result-configuration OutputLocation=${{ env.ATHENA_OUTPUT }} \
                  --query 'QueryExecutionId' --output text)
          for i in {1..60}; do
            STATE=$(aws athena get-query-execution --query-execution-id "$QID" \
                    --query 'QueryExecution.Status.State' --output text)
            [ "$STATE" = "SUCCEEDED" ] && break
            [ "$STATE" = "FAILED" ] && echo "MSCK hourly failed" && exit 1
            sleep 2
          done

      # --------- 3) Refresh partitions for daily ----------
      - name: MSCK daily
        run: |
          set -euo pipefail
          Q="MSCK REPAIR TABLE ${{ env.DB }}.weather_daily"
          QID=$(aws athena start-query-execution \
                  --work-group primary \
                  --query-string "$Q" \
                  --result-configuration OutputLocation=${{ env.ATHENA_OUTPUT }} \
                  --query 'QueryExecutionId' --output text)
          for i in {1..60}; do
            STATE=$(aws athena get-query-execution --query-execution-id "$QID" \
                    --query 'QueryExecution.Status.State' --output text)
            [ "$STATE" = "SUCCEEDED" ] && break
            [ "$STATE" = "FAILED" ] && echo "MSCK daily failed" && exit 1
            sleep 2
          done

      # --------- 4) Sanity check that today's rows exist ----------
      - name: Sanity check today's hourly rows per location
        run: |
          TODAY=$(date -u +%Y-%m-%d)
          SQL="SELECT location, COUNT(*) AS c
               FROM ${{ env.DB }}.${{ env.HOURLY_TABLE }}
               WHERE date = DATE '$TODAY'
               GROUP BY 1;"
          QID=$(aws athena start-query-execution \
                  --work-group primary \
                  --query-string "$SQL" \
                  --result-configuration OutputLocation=${{ env.ATHENA_OUTPUT }} \
                  --query 'QueryExecutionId' --output text)
          for i in {1..30}; do
            STATE=$(aws athena get-query-execution --query-execution-id "$QID" \
                    --query 'QueryExecution.Status.State' --output text)
            [ "$STATE" = "SUCCEEDED" ] && break
            [ "$STATE" = "FAILED" ] && echo "Sanity query failed" && exit 1
            sleep 2
          done

      # --------- 5) Ensure Iceberg table exists ----------
      - name: Ensure Iceberg table exists
        run: |
          CREATE="
          CREATE TABLE IF NOT EXISTS ${{ env.DB }}.${{ env.ICEBERG_TABLE }} (
            date           date,
            location       string,
            avg_temp       double,
            avg_humidity   double,
            avg_windspeed  double,
            total_precip   double
          )
          PARTITIONED BY (date, location)
          LOCATION 's3://${{ env.S3_BUCKET }}/gold/city_daily_summary_iceberg/'
          TBLPROPERTIES ('table_type'='ICEBERG','format'='PARQUET');"
          aws athena start-query-execution \
            --work-group primary \
            --query-string "$CREATE" \
            --result-configuration OutputLocation=${{ env.ATHENA_OUTPUT }}

      # --------- 6) Insert today's aggregated data into Iceberg ----------
      - name: Upsert today's partition into Iceberg
        run: |
          TODAY=$(date -u +%Y-%m-%d)
          SQL="
          INSERT INTO ${{ env.DB }}.${{ env.ICEBERG_TABLE }}
          SELECT
            date,
            location,
            AVG(temperature_2m)       AS avg_temp,
            AVG(relative_humidity_2m) AS avg_humidity,
            AVG(windspeed_10m)        AS avg_windspeed,
            SUM(precipitation)        AS total_precip
          FROM ${{ env.DB }}.${{ env.HOURLY_TABLE }}
          WHERE date = DATE '$TODAY'
          GROUP BY date, location;"
          aws athena start-query-execution \
            --work-group primary \
            --query-string "$SQL" \
            --result-configuration OutputLocation=${{ env.ATHENA_OUTPUT }}

      # --------- 7) Verify Iceberg updated for both cities ----------
      - name: Validate Iceberg partition for both cities
        run: |
          TODAY=$(date -u +%Y-%m-%d)
          SQL="
          SELECT location, COUNT(*) AS c
          FROM ${{ env.DB }}.${{ env.ICEBERG_TABLE }}
          WHERE date = DATE '$TODAY'
          GROUP BY 1;"
          QID=$(aws athena start-query-execution \
                  --work-group primary \
                  --query-string "$SQL" \
                  --result-configuration OutputLocation=${{ env.ATHENA_OUTPUT }} \
                  --query 'QueryExecutionId' --output text)
          for i in {1..30}; do
            STATE=$(aws athena get-query-execution --query-execution-id "$QID" \
                    --query 'QueryExecution.Status.State' --output text)
            [ "$STATE" = "SUCCEEDED" ] && break
            [ "$STATE" = "FAILED" ] && echo "Iceberg validation failed" && exit 1
            sleep 2
          done

